---
title: "图形学中的有限元方法"
categories: ["计算机图形学"]
author: "CaptainChen"
---

Finite Element Method (FEM, 有限元方法) 时一种将物体看作许多有体积的微小单元来进行仿真的方法。比如将二维图形拆分成若干三角形，将三维体拆分成若干四面体。这种方法能够很好的模拟弹性体的形变等特点，能够在数学上证明其仿真方法一定收敛到解析解，比MPM等使用粒子模拟的方法更加准确，但同时也更加复杂，运算更慢。

本文将先从弹性体相关的物理量基础定义开始，再讲述各种弹性体的能量函数模型，最后阐述如何用有限元方法离散化进行仿真。

> 本文主要参考[FEM simulation of 3D deformable solids Siggraph 2012 Course](https://dl.acm.org/doi/10.1145/2343483.2343501)，并修正了一些不明确的可能错误的地方

## 弹性体基础

弹性体指的是能够自己恢复初始状态的材料

超弹性体（hyperelasticity）是一种特殊的弹性体，指的是弹力与压缩（拉伸）的路径没有关系，只与压缩后的状态有关系。

本文只考虑超弹性体。

### 形变与能量

定义弹性体的区域为 $ \Omega $ ，弹性体上初始时每个点的位置为 $ X $ 。弹性体发生平移、形变等变化后，弹性体上每一个点都将移动到另一个位置 $ \textbf{x} $ ，可以用一个形变映射(deformation map)来表示弹性体的这一个变换 $ \textbf{x} = \phi (X) $ ，如下图

![](/assets/cg/FEM01.png)
{: .center-image}

$ \phi(X) $ 并不能表示形变，因为弹性体整体的移动不产生形变，而相近的点移动的区别产生形变，则可以使用形变映射函数到初始位置的导数作为表示形变的量：
$$
F = \frac {\partial \phi (X)} {\partial X} = \frac {\partial \textbf{x}} {\partial X}
$$
在三维情况下，这是一个3×3的矩阵，即雅可比矩阵， $ F $ 被称为形变梯度(deformation gradient)

$ F $ 形变梯度表示某一点 $ X $ 相对其邻域的形变，形变产生弹性势能，所以需要定义针对这一点的能量密度 $ \Psi(\phi, X) $ ，弹性体的总能量即为 $ E(\phi) = \int_{\Omega} \Psi(\phi, X) \mathrm{d} X $ . 一般情况下，能量密度只与形变梯度有关，可写为 $ \Phi(F) $ .

注意到 $ \text{det}(F) = J = \frac {V_{变换后}} {V_{初始}} $ ，即 $ F $ 的行列式可以表示体积的变化

### 弹性内力

接下来计算弹性内力，在数学上需要区分内部力和边界力

对于体积内部，令 $ f(X) $ 表示位置 $ X $ 处的力密度(单位 $ N/m^3 $ )，则一个体积 $ A \subset \Omega $ 内的受力为 $ \textbf{f}_{agg}(A) = \int_A f(X) \mathrm{d}X $ 

对于边界上，令 $ \tau(X) $ 表示边界位置 $ X $ 处的力密度(单位 $ N/m^2 $ )，则一块三维体表面 $ B \subset \partial \Omega $ 的受力为 $ \textbf{f}_{agg}(B) = \oint_B \tau(X) \mathrm{d}X $ 

内力即为弹性势能梯度的相反方向，因为内力总是往使得势能减小最快的方向进行，所以内力可以为 $ \textbf{f} = - \frac {\partial E} {\partial \textbf{x}} $ ，注意这里是变换后的位置

### PK1数

因为内力是势能的梯度相反方向，所以我们试图用总势能对位置求梯度，看看能得到什么
$$
\begin{align}
\delta E & = \delta \left[ \int_\Omega \Psi(F) \mathrm{d}X \right] \\
& = \int_\Omega \delta \left[ \Psi(F) \right] \mathrm{d}X \\
& = \int_\Omega \left[ \frac {\partial \Psi} {\partial F} : \delta F\right] \mathrm{d}X 
\end{align}
$$
> 注意公式中的 $ \left[A : B\right ] $ 表示矩阵 $ A, B $ 按位点乘，上述公式是微分链式法则用到了点乘
>
> 之后 $ [ : ] $ 均表示按位点乘，有时候还需要按位点乘后再将每个元素加起来，请根据上下文判断

令 $ P = \frac {\partial \Psi} {\partial F} $ ，被称为PK1数(The first Piola-Kirchhoff stress tensor)，下面将推导 $ P $ 的几何意义

继续推导能量的微分：*(并不严谨，siggraph原文也说不严谨，所以我并不知道倒数几行的负号哪里来，也不知道怎么从边界变出法向量然后消掉偏导算子的)*
$$
\begin{align}
\delta E & = \int_\Omega \left[ P : \delta F\right] \mathrm{d}X \\
& = \int_\Omega \left[ P : \frac {\partial} {\partial X} \delta  \phi(X) \right] \mathrm{d}X \\
& = \sum_{i,j} \int_\Omega \left[ P_{ij} \cdot \frac {\partial} {\partial X_j} \delta  \phi_i(X) \right] \mathrm{d}X \\
& 将积分区域拆为内部和边界 \\
& = \sum_{i,j} \left[-\int_\Omega \frac {\partial P_{ij}} {\partial X_j} \delta  \phi_i(X) \mathrm{d}X + \oint_\Omega P_{ij} N_j \delta \phi_i(X) \mathrm{d}X \right] \\
& = \left[-\int_\Omega \textbf{div} P \cdot \delta \textbf{x}\cdot  \mathrm{d}X + \oint_\Omega (P \cdot N) \delta \textbf{x} \cdot \mathrm{d}X \right] \\
\end{align}
$$
因为出现了对于当前位置 $ \textbf{x} $ 的微分 $ \delta \textbf{x} $，根据力的定义，可以把积分前半部分视为力密度

即 $ f(\textbf{x}) = \textbf{div} P $ ， $ \tau(\textbf{x}) = - P\cdot N $ 

可以理解为PK1数表示的是对该点某一方向微平面的压强

## 弹性能量模型

本节将探讨不同的弹性模型如何从形变梯度定义能量密度，计算出内力

### 应变量度

为了计算出能量，我们需要一个衡量形变程度的度量方式， $ F $ 只是一个表示形变的量，并不能衡量形变程度。

注意到形变梯度 $ F $ 实际上仅包含变换的旋转和拉伸，矩阵一定可以分解为 $ F=RS $ ，其中 $ R $ 为旋转矩阵，满足 $ R^T R=I $ ；$ S $ 为拉伸矩阵，一定为对称的。形变的量度可以仅与拉伸有关：
$$
E=\frac 1 2 (S^2-I) = \frac 1 2 (F^T F - I)
$$
注意这里的 $ E $ 不是能量，这被称为**格林应变张量**(Green strain tensor)，是一个3×3的矩阵，用于衡量各个方向的形变程度。这是一个与旋转、平移无关的量度，但它是非线性的。

尝试简化，我们对 $ E $ 在 $ F=I $ 进行泰勒展开：
$$
\begin{align}
E(F) & ≈ E(I) + \frac {\partial E} {\partial F}\bigg |_{F=I} : (F-I) \\
& = E(I) +\frac 1 2 \left[ (F-I)^T I + I^T (F-I) \right] \\
& = \frac 1 2 (F+F^T) - I
\end{align}
$$
其中第一行到第二行的求法是使用微分 $ \frac {\partial E} {\partial F} : \delta F = \delta E = \frac 1 2 (\delta F^T F + F^T \delta F) $ 

我们由此定义了另一个量度：
$$
\epsilon = \frac 1 2 (F+F^T) - I
$$
称为微小应变张量(small strain tensor, infinitesimal strain tensor)，是一个线性的应变张量，但其却是与旋转有关的，弹性体在不形变的情况下发生旋转也会改变 $ \epsilon $

**注意到 $ \epsilon $ 一定为对称矩阵，其点乘一个反对称矩阵一定为 $ \textbf{0} $**

### 线性弹性模型  Linear elasticity

定义：
$$
\Psi(F) = \mu \text{tr}(\epsilon^2) + \frac \lambda 2 \text{tr}^2(\epsilon)
$$
这是线性弹性模型的能量密度，其中 $ \mu = \frac {k} {2(1+\nu)} $ ,  $ \lambda = \frac {k \nu} {(1 + \nu) ( 1-2 \nu)} $ 被称为拉梅系数 (Lamé coefficients) 。其中的 $ k $ 为杨氏模量 (Young's modulus) ，一般表示拉伸抵抗性。 $ \nu $ 为泊松比，一般表示不可压缩性。

通过对 $ \Psi $ 微分来求 $ P $ 
$$
\begin{align}
\delta \Psi & = \mu \cdot \text{tr}(\delta \epsilon \cdot  \epsilon +\epsilon \delta \epsilon) + \lambda \text{tr}(\epsilon ) \text{tr}(\delta \epsilon) \\
\delta \epsilon & = \frac 1 2 \left( \delta F + \delta F^T \right) \doteq \text{Sym}(\delta F) \ 
\end{align}
$$

> 注：任意矩阵都可以拆分为一个对称矩阵和反对称矩阵之和 $ A = \text{Sym}(A) + \text{Anti-Sym}(A)$
>
> 对称矩阵点乘一个矩阵： $ \epsilon : A = \epsilon : \text{Sym}(A) $ 
>
> 注2：矩阵的迹中两矩阵相乘是可以交换的： $ \text{tr}(AB) = \text{tr}(BA) $  ，可以展开对角线元素计算证明。还可以是可转置的 $ \text{tr} (A) = \text{tr} (A^T) $
>
> 注3：矩阵的迹的微分可以视为矩阵对角元素的微分，其余为0，则可以写为 $ \delta \text{tr}(\epsilon) = \text{tr}(\delta \epsilon) = I : \delta \epsilon $ 

$$
\begin{align}
\delta \Psi & = 2\mu \cdot \text{tr}(\delta \epsilon \cdot \epsilon ) + \lambda \text{tr} (\epsilon) \left( I : \text{Sym}(\delta F) \right) \\
& = 2\mu \cdot (I : \text{Sym}(\delta F)\epsilon) + \lambda \text{tr} (\epsilon) \left( I : \text{Sym}(\delta F) \right) \\
& = 2\mu \cdot (\epsilon : \text{Sym}(\delta F)^T) + \lambda \text{tr} (\epsilon) \left( I : \text{Sym}(\delta F) \right) \\
& = (2\mu \epsilon + \lambda \text{tr} (\epsilon) I) : \text{Sym}(\delta F) \\
& = (2\mu \epsilon + \lambda \text{tr} (\epsilon) I) : \delta F \\
\Rightarrow P & = 2\mu \epsilon + \lambda \text{tr} (\epsilon) I \\
& = \mu (F + F^T - 2I) + \lambda \text{tr} (F - I) I
\end{align}
$$

我们得出了线性弹性模型的PK1数： $ P  = \mu (F + F^T - 2I) + \lambda \text{tr} (F - I) I $

这个模型是线性的，容易计算，但是其与旋转相关

###  圣维南-基尔霍夫模型 St. Venant-Kirchhoff model (STVK)

使用格林应变张量( $ E = \frac 1 2 (F^T F - I) $ )定义的非线性模型：(注意到 $ E $ 为对称矩阵)
$$
\Psi (F) = \mu \text{tr}(E^2) + \frac \lambda 2 \text{tr}^2(E)
$$
同样，对其微分来求  $ P $ ：
$$
\begin{align}
\delta \Psi (F) & = 2\mu \cdot \text{tr} (E\delta E) + \lambda \text{tr}(E) \text{tr}(\delta E) \\
\delta E  & = \frac 1 2 (\delta F^TF + F^T \delta F) = \text{Sym}(F^T \delta F) \\
\text{tr} (E\delta E) & = I: E\cdot \text{Sym} (F^T \delta F) = E : \text{Sym} (F^T \delta F)^T = E: F^T \delta F = FE : \delta F \\
\text{tr} (\delta E) & = I: \text{Sym}(F^T \delta F) = I:F^T \delta F = F : \delta F \\
\Rightarrow \delta \Psi(F) & = 2 \mu FE : \delta F + \lambda \text{tr}(E) F:\delta F \\
& = (2\mu FE + \lambda \tr(E) F):\delta F \\
\Rightarrow  P &= 2\mu FE + \lambda \text{tr} (E) F = F(2 \mu E + \lambda \text{tr}(E) I)
\end{align}
$$

> 注：上面第三行用了性质 $ A : B^T C = BA : C $ ，可以通过展开点乘和矩阵乘法证明 
>
> 注2：点乘易错点 $ A(B:C) \neq (AB) : C $ 

于是我们得到了StVK模型的PK1数： $ P = F(2 \mu E + \lambda \text{tr}(E) I) $ 

 这其实是一个关于 $ F $ 的三次式，十分复杂，运算复杂度高，优势在于他是一个旋转无关的模型，更符合现实。其仍有仿真缺陷，当弹性体被压缩到一定程度后，其抵抗压缩的力会突然减小（？），导致弹性体更容易被压缩到一个质点

### 共旋转线性模型  (Corotated Linear Elasticity)

线性模型没有旋转无关性，StVK效率很低，于是Corotated Linear Elasticity试图折衷考虑两者。

~~*比较复杂，不细讲*~~
$$
\Psi (F) = \mu \| S - I \| ^2_F +\frac \lambda 2 \text{tr}^2(S-I)
$$
其中 $ S $ 为包含在 $ F $ 中的拉伸矩阵 $ F = RS $ 
$$
P = 2 \mu (F - R) + \lambda \text{tr} (R^T F - I) R
$$
相比于线性模型，直观的理解是这个模型手动减去 $ R $ 直接去除旋转的影响

### 旋转无关、各向同性与NeoHookean模型

**旋转无关**，指弹性体整体旋转不会改变每个位置的能量密度，可以写为 $ \Psi(RF)=\Psi(F) $ ，即先变换后，再进行旋转不会影响能量。

**各向同性**，弹性体从任意方向进行相同的变换（拉伸旋转平移等）不会影响每个位置的能量密度，可以写为 $ \Psi(FQ) = \Psi(F) $ ，即先旋转再进行相同的变换不影响能量。

若模型既是旋转无关也是各向同性的，则能量密度函数满足： $ \Psi (RFQ) = \Psi (F) $ 

根据这个形式，自然想到将 $ F $ 进行奇异值分解(SVD) ： $ F = U \Sigma V^T $ ，其中 $ U $ 和 $ V $ 一定为酉矩阵，即 $ U^T U =V^T V=I $ ，与旋转矩阵一致。而 $ \Sigma $ 为对角矩阵，在3维情况下自由度仅为3.

故一个满足旋转无关且各向同性的模型，一定满足 $ \Psi (F) = \Psi (\Sigma) $ ，并且一定存在某种定义方式，只需要自由度为3的变量，就能定义能量密度函数 $ \Psi $ 。使用 $ F $ 的特征值当然是一种办法，但其非常不方便，所以这里定义了另外3个线性无关的变量，被称作各向同性不变量(isotropic invariants)：

> 注：没有下标的 $ I $ 均表示单位矩阵，有下标的表示各向同性不变量

$$
\begin{align}
I_1(F) &= \text{tr}(\Sigma ^2) = \text{tr}(F^T F) \\
I_2(F) &= \text{tr}(\Sigma ^4) = \text{tr}\left[(F^T F)^2\right] \\
I_3(F) &= \text{det}(\Sigma ^2) = (\text{det}F)^2 \\
\end{align}
$$
对这3个变量求微分可以得到：
$$
\begin{align}
\delta I_1 & = 2(I:F:\delta F) = 2F : \delta F \\
\delta I_2 & = 4\text{tr} \left( F^TFF^T\delta F \right) = 4 I: F^TFF^T\delta F = FF^TF:\delta F \\
\delta I_3 & = 2\text{det}(F)\delta [\text{det} F] = 2 (\text{det}F)^2(F^T)^{-1} : \delta F
\end{align}
$$
其中 $ I_3 $ 用了[行列式微分](https://zhuanlan.zhihu.com/p/144255438)

现在可以定义Neohookean模型了：
$$
\Psi(I_1, I_3) = \frac \mu 2 \left[I_1-\log(I_3) - 3\right] + \frac \lambda 8 \log^2(I_3)
$$
此时PK1数很好求：
$$
\begin{align}
P & = \frac {\partial \Psi} {\partial F} \\
& = \frac \mu 2 \left( \frac {\partial I_1} {\partial F} - \frac 1 {I_3} \frac {\partial I_3} {\partial F} \right) + \frac {\lambda \log(I_3)} {4 I_3} \frac {\partial I_3} {\partial F} \\
& = \mu \left( F- F^{-T} \right) + \frac \lambda 2 \log(I_3) F^{-T}
\end{align}
$$
Neohookean模型保证了旋转无关，各向同性，其能处理强压缩，虽然容易数值爆炸，因为 $ I_3 = J^2 $ ，当压缩力很大时，体积变化分数 $ J \rightarrow 0 $ ，会导致能量中的 $ \log $ 趋于无穷大，能量也非常大。

### 各种弹性能量模型对比

借用[课程上的一张表](https://vcl-pku.github.io/vci-book/animation/elastomers/fem.html#id14)

| 名称 | $ \Psi $ | $ P $ | 效率 | 旋转无关 | 各向同性 | 能处理强压缩 |
| :--: | :------: | :---: | :--: | :------: | :------: | :------: |
| 线性模型 | $ \mu \text{tr}(\epsilon^2) + \frac \lambda 2 \text{tr}^2(\epsilon) $ | $ \mu (F + F^T - 2I) + \lambda \text{tr} (F - I) I $ | 高 | 否 | 否 | 否 |
| StVK | $ \mu \text{tr}(E^2) + \frac \lambda 2 \text{tr}^2(E) $ | $ F(2 \mu E + \lambda \text{tr}(E) I) $ | 低 | 是 | 是 | 否 |
| Corotated | $ \mu \|S - I \|^2_F +\frac \lambda 2 \text{tr}^2(S-I) $ | $ 2 \mu (F - R) + \lambda \text{tr} (R^T F - I) R $ | 中 | 是 | 是 | 否 |
| Neohookean | $ \frac \mu 2 \left[I_1-\log(I_3) - 3\right] + \frac \lambda 8 \log^2(I_3) $ | $ \mu \left( F- F^{-T} \right) + \frac \lambda 2 \log(I_3) F^{-T} $ | 低 | 是 | 是 | 是 |

## 有限元方法离散化

在前面有关弹性体的所有推导中，都是将弹性体视为一个拥有无限点的三维区域，这使得计算机无法进行仿真。有限元方法的目的就是用有限的元素去拟合一个无穷的区域，在这里，我们将三维弹性体视为若干个四面体元素：

![](/assets/cg/FEM02.png)
{: .center-image}

在四面体内部，变换函数将变成线性函数： $ \hat{\phi}(X) = AX+b $ ，因此变换梯度也变得简单： $ F = A $ . 并且 $ F $ 可以使用四面体上的四个点解方程解出来：
$$
\begin{align}
\left[\begin{matrix}
 \textbf{x}_1-\textbf{x}_4 & \textbf{x}_2-\textbf{x}_4 & \textbf{x}_3-\textbf{x}_4
\end{matrix}\right] & = F\cdot \left[\begin{matrix}
 X_1-X_4 & X_2-X_4 & X_3-X_4
\end{matrix}\right] \\
D_s & = F \cdot D_m \\
\Rightarrow F & = D_s D_m^{-1}
\end{align}
$$
令 $ W $ 为四面体的体积，可以计算得到 $ W = \frac 1 6 \left | \text{det} D_m \right | $ 

则四面体内部 $ T_i $ 的弹性势能为：
$$
E_i = \int_{T_i} \Psi (F_i) \mathrm{d}X = W_i \Psi (F_i)
$$
每一个四面体都会对它的4个顶点施加弹力，对每一个顶点需要计算它相关的所有四面体对它贡献的弹力，第 $ i $ 个四面体对其第 $ j $  个顶点的贡献为 $ f_i^j = - \frac {\partial E_i} {\partial \textbf{x}_j} $ 

令 $ H_i = [ f_i^1\ \ f_i^2\ \ f_i^3] $ ，则：
$$
\begin{align}
f_i^j & = - \frac {\partial E_i} {\partial \textbf{x}_j} \\
& = -\frac {\partial E_i} {\partial \Psi} \frac {\partial \Psi} {\partial F_i} \frac {\partial F_i} {\partial \textbf{x}_j} \\
& = \left[-W_i P(F_i)D_m^{-T}\right]_{ji} \\
\Rightarrow H_i & = -W_i P(F_i)D_m^{-T}
\end{align}
$$
对于四面体第四个顶点： $ f_i^4 = -f_i^1 -f_i^2 -f_i^3 $ ，因为弹性内力要保证整个四面体合力为零 

由此可以算出弹性体分成四面体元素后，内部每一个顶点的受力

## 时间积分

前文已经详细讲述了如何计算通过将弹性体视为四面体后计算每个顶点的受力，知道受力后就可以很方便的使用显示时间积分进行仿真，但隐式时间积分仍然比较困难。本节介绍弹性体仿真时间积分的处理方式，以及一些算法实践上的具体处理。

###  显示时间积分

以下符号，向量都代表整个弹性体所有点，即 $ m $ 个点，如 $ \textbf{x} $ 为 $ 3m $ 维

对每一个节点进行如下操作：
$$
\begin{align}
\textbf{x}_{n+1} & = \textbf{x}_n + \textbf{v}_{n+1} \Delta t \\
\textbf{v}_{n+1} & = \textbf{v}_n + M^{-1} \left[f_{int} (\textbf{x}_n)+f_{damp}(\textbf{v}_n) + f_{ext}\right] \Delta t
\end{align}
$$
其中 $ f_{int} $ 表示内力，就是弹性体内部的弹力，需要用前文所述的各种能量计算出来

$ f_{damp} $ 表示阻尼力，与速度有关，用于能量损耗

$ f_{ext} $ 为外力，一般与弹性体形态无关，很容易计算，如重力

### 隐式时间积分

需要计算如下方程：
$$
\begin{align}
\textbf{x}_{n+1} & = \textbf{x}_n + \textbf{v}_{n+1} \Delta t \\
\textbf{v}_{n+1} & = \textbf{v}_n + M^{-1} \left[f_{int} (\textbf{x}_{n+1}) + f_{damp}(\textbf{v}_{n+1}) + f_{ext}\right] \Delta t
\end{align}
$$
*对于阻尼力  $ f_{damp} $ ，如果难以处理，也可以使用 $ f_{damp} (\textbf{v}_n ) $ 做半隐式积分。*

对于内力 $ f_{int} (\textbf{x}_{n+1}) $ ，一般采用泰勒展开近似：(省略了下标)
$$
f (\textbf{x}_{n+1}) ≈ f (\textbf{x}_n) + \frac {\partial f} {\partial \textbf{x}} \bigg |_{\textbf{x}_n}(\textbf{x}_{n+1} - \textbf{x}_n)
$$
为此我们需要求解刚度矩阵： $ K(\textbf{x}_n) = - \frac {\partial f} {\partial \textbf{x}} \bigg |_{\textbf{x}_n} $ ，这个刚度矩阵是一个 $ 3m \times 3m $ 的矩阵，但我们计算时一般只考虑一个四面体，一个四面体至少需要考虑到3个顶点，那么算法运行时需要用到一个 $ 3 \times 3 \times 3 \times 3 $ 的矩阵，这依然是一个比较大的运算量。实现时，可以直接将这个巨型矩阵直接算出来（比如[VegaFEM](https://viterbi-web.usc.edu/~jbarbic/vega/download.html)）；也可以用隐式计算的方法，直接计算  $ K \cdot w $ ，只需要在求微分 $ \delta K $ 之后，把里面的所有 $ \delta \textbf{x} $ 换成 $ w $ 即可。

现在来考察一下 $ K $ ，通过对力 $ f $ 求微分来推导：
$$
\begin{align}
K(\textbf{x}_n) \delta \textbf{x} & = \frac {\partial f} {\partial \textbf{x}} \delta \textbf{x} = \delta f \\
\delta H & = \left[ \begin{matrix} \delta f_1 & \delta f_2 & \delta f_3 \end{matrix} \right] \\
& = - W \delta P (F) D_m^{-T} \\
\delta P(F) & = \begin{cases}
   \delta F \left[ 2 \mu E + \lambda \text{tr}(E) I \right] + F \left[ 2 \mu \delta E + \lambda \text{tr}(\delta E) I \right] &\text{if using StVK model} \\
   \mu \delta F + \left[ \mu - \lambda \log (J) \right] F^{-T} \delta F^T F^{-T} + \lambda \text{tr}(F^{-1} \delta F) F^{-T} & \text{if using Neohookean model} \\
\end{cases} \\
\delta F & = (\delta D_s) D_m^{-1} \\
\delta D_s & = \left[ \begin{matrix}
\delta \textbf{x}_1 - \delta \textbf{x}_4 & \delta \textbf{x}_2 - \delta \textbf{x}_4 & \delta \textbf{x}_3 - \delta \textbf{x}_4
\end{matrix} \right]
\end{align}
$$
> 注： $ J = \sqrt {I_3} = \text{det} F $ 是体积变化分数

根据以上公式可以对任意弹性模型计算 $ K(\textbf{x}_n)\cdot w $ ，只需要最终在 $ \delta D_s $ 中，把 $ \delta \textbf{x} $ 替换为对应位置的 $ w $ 即可。在[Siggraph 2012的FEM course](https://dl.acm.org/doi/10.1145/2343483.2343501)中推荐的就是这个计算 $ K $ 的方法。=

#### VegaFEM的实现方法

令 $ \Delta \textbf{x} = \textbf{x}_{n+1} - \textbf{x}_n , \Delta \textbf{v} = \textbf{v}_{n+1} - \textbf{v}_n $ 

对于阻尼力，令 $ f_{damp} (\textbf{v}_{n+1}) = (\alpha_1 \cdot (-K(\textbf{x}_n)) + \alpha_2 \cdot M) \cdot \textbf{v}_{n+1} = -D \cdot \textbf{v}_{n+1} $  

则
$$
\begin{align}
\Delta \textbf{v} & = \Delta t M^{-1}\left[ f_{int}(\textbf{x}_n) - K(\textbf{x}_n) \cdot \Delta \textbf{x} - D \cdot \textbf{v}_{n+1} \right] \\
M \cdot \Delta \textbf{v} & = \Delta t f_{int} (\textbf{x}_n) - \Delta t^2 K(\textbf{x}_n) \cdot \Delta \textbf{v} - \Delta t D (\textbf{v}_n + \Delta \textbf{v}) \\
\left[\Delta t^2 K(\textbf{x}_n) + \Delta t D + M \right] \cdot \Delta \textbf{v} & = \Delta t \left[f_{int}(\textbf{x}_n) - (\Delta t K(\textbf{x}_n) + D) \textbf{v}_n\right]
\end{align}
$$
方程已经变成了 $ AX=b $ 的形式，可以使用牛顿-拉夫逊方法迭代解出 $ \Delta \textbf{v} $ 

> 注： [Siggraph 2012的FEM course](https://dl.acm.org/doi/10.1145/2343483.2343501)中的方法与此类似，只不过公式的推导过程变成了求解 $ \Delta \textbf{x} $ 而不是 $ \Delta \textbf{v} $ 

#### Incremental Potential Contact (IPC) 方法

$$
\begin{align}
\textbf{x}_{n+1} & = \textbf{x}_n + \textbf{v}_{n+1} \Delta t \\
\textbf{v}_{n+1} & = \textbf{v}_n + M^{-1} \left[f_{int} (\textbf{x}_{n+1}, \textbf{v}_{n+1}) + f_{ext}\right] \Delta t \\
\Rightarrow \textbf{x}_{n+1} & = \textbf{x}_n + \Delta t \textbf{v}_n + \Delta t^2 M^{-1} \left[f_{int}(\textbf{x}_{n+1}, \textbf{v}_{n+1}) + f_{ext}\right] \\
\textbf{x}_{n+1} & - \left( \textbf{x}_n + \Delta t \textbf{v}_n + \Delta t^2 M^{-1} f_{ext}\right) - \Delta t^2 M^{-1} f_{int}(\textbf{x}_{n+1}, \textbf{v}_{n+1}) = 0 \\
令 \hat{\textbf{x}}_n & = \textbf{x}_n + \Delta t \textbf{v}_n + \Delta t^2 M^{-1} f_{ext} \\
M(\textbf{x}_{n+1} & - \hat{\textbf{x}}_n) - \Delta t^2 f_{int} (\textbf{x}_{n+1} , \textbf{v}_{n+1}) = 0
\end{align}
$$

我们将其转为一个优化问题，即最小化：
$$
E(\textbf{x}) = \frac 1 2 \left \| \textbf{x} - \hat{\textbf{x}}_n \right \|_M + \Delta t^2 \Psi (\textbf{x}) \\
因为 E'(\textbf{x}) = M(\textbf{x}_{n+1} - \hat{\textbf{x}}_n) - \Delta t^2 f_{int} (\textbf{x}_{n+1} , \textbf{v}_{n+1}) \\
则只需求解 \textbf{x}_{n+1} = \text{argmin}_{\textbf{x}} E(\textbf{x})
$$
$ E(\textbf{x}) $ 被称为 Increment Potential，可以看出 $ \frac 1 2 \left \| \textbf{x} - \hat{\textbf{x}}_n \right \|_M $ 与惯性势能相关，$ \Delta t^2 \Psi(\textbf{x}) $ 与弹性势能有关。优化问题的目的就是找到一个势能最小的位置作为下一时间步的状态。注意到这个 $ E(\textbf{x}) $ 还可以添加其他能量包括碰撞，摩擦等。

IPC使用牛顿-拉夫逊方法结合线搜索(line search)迭代优化 $ E(\textbf{x}) $ ，即
$$
H_E(\textbf{x}) \cdot v = - D_E(\textbf{x})
$$
其中 $ H_E(\textbf{x}) $ 为 $ E $ 的二阶导（海塞矩阵）， $ D_E $ 为一阶导，这里面涉及到对 $ \Psi $ 求二阶导

求解出 $ v $ 后作为搜索的方向，使用线搜索结合连续碰撞检测(CCD)，找到最佳步长进行移动，重复这个步骤直到时间步长加起来达到一个仿真步。

## 参考资料

[FEM simulation of 3D deformable solids Siggraph 2012 Course](https://dl.acm.org/doi/10.1145/2343483.2343501)

[VegaFEM](https://viterbi-web.usc.edu/~jbarbic/vega/SinSchroederBarbic2012.pdf)

[IPC](https://ipc-sim.github.io/file/IPC-paper-fullRes.pdf)

[北京大学可视计算与交互概论](https://vcl-pku.github.io/vci-book/animation/elastomers/fem.html)
