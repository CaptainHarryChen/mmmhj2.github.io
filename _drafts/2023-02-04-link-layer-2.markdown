---
layout: post
title: "计算机网络——链路层②"
---

## 交换局域网

我们此前研究过使用路由器组成路由局域网的各种理论，现在，我们将研究由链路层交换机组成的局域网。

### 链路层寻址与地址解析协议

主机和路由器具有链路层地址，这看起来相当多余，因为它们已经具有一个全球唯一（不考虑NAT）的网络层地址了。
这是出于两个理由：
1. 链路层和网络层单独寻址允许相同的链路层部件承载不同的网络层协议；
2. 链路层地址几乎不可变，因此不需要重新配置。

本节我们将介绍链路层地址和其用处。

#### MAC地址

主机或路由器的每一个接口（即适配器）具有链路层地址。
原则上讲，链路层交换机的接口*不具有*这个地址，因为它们不需要被寻址。
交换机*透明地*执行转发帧的工作，主机和路由器不必明确地寻址到交换机。
实际上，交换机上需要运行一些其他协议（比如防止环路的生成树协议，STP），所以许多链路层交换机接口也有自己的链路层地址。

链路层地址有多种称呼，如**物理地址**（Physical address）和**MAC地址**。
对绝大多数局域网（包括以太网和802.11无线局域网）而言，MAC地址为6个字节，通常表示为六个短横线分隔的十六进制数。
设定上MAC地址是永久的，但实际上存在修改它的软件方法。
这里值得注意的是，MAC地址作为链路层的一部分存在，任何使用TCP/IP协议栈的网络，都必须规定链路层地址，这种地址并不是以太网或WiFi特有的。

局域网的正常工作要求*同一交换局域网内*不同设备的MAC地址必须不同，正如我们此前看到的，在网络层（第三层）搭建的网络不需要使用MAC地址进行寻址。
这和IPv4地址的要求不同，加上其巨大的取值范围，人们暂时还不关心MAC地址耗尽的问题。

MAC地址分为前三字节和后三字节，前三字节由制造商向电气电子工程师学会（Institute of Electrical and Electronics Engineers，IEEE）申请，后三字节由厂商分配。

适配器的MAC地址具有*扁平结构*，与IP地址的*层次结构*不同。
从MAC地址并不能判断出一个设备位于哪个子网，相对地，一般情况下，无论设备位于何处，这个地址都不会改变。

当适配器需要向目的适配器发送一个帧时，其通过ARP找到目的适配器的MAC地址，然后把地址插入帧中，发送到局域网上。
对于交换机组成的交换局域网，交换机接收到这个帧后，决定如何转发这个帧。

MAC地址使用个体/群组位（I/G bit）识别一个地址代表单个适配器（单播）还是一组适配器（组播）。
组播地址中最特别的一个是全一的地址`FF-FF-FF-FF-FF`，这个地址对应所有接收端，称为**广播地址**。

#### 地址解析协议

**地址解析协议**（Address Resolution Protocol，ARP）是一个工作在网络层和链路层之间的协议。
这个协议负责执行从IPv4地址到MAC地址之间的转换，IPv6使用*邻居发现协议*（Neighbor Discovery Protocol，NDP）执行此功能。
这一协议的报文内容根据链路层协议不同而不同，因为不同的链路层协议可能具有不同的MAC地址约定。

ARP使用**ARP表**（ARP table）工作。
这张表有三个字段：IP地址，MAC地址和存活时间（TTL）。
进行地址查询非常简单，只需要检查IP地址，然后取出MAC地址即可。
存活时间通常为20分钟，如果20分钟后一个表项还未使用，则将它删除。

现在我们考虑如何填充ARP表。
加入ARP表中没有请求的IP地址，那么请求方，即请求MAC地址一方，会在链路层上直接构造一个特殊的**ARP分组**。
ARP分组需要包括发送方和接收方的网络地址和物理地址。
请求方填入发送方的IP和MAC地址和接收方的IP地址，但是接收方的物理地址为止，因此使用*广播地址*。
这个地址会向经过交换机被广播到所有相连的接口上。
收到的主机检查其IP地址，如果相同，则构造回复。
对ARP协议，其请求和回复具有相同的格式，因此被请求方也需要填充上述四个参数。
幸运的是，在ARP请求含有请求方的MAC地址和IP地址，因此被请求方可以填充这些参数。
请求方收到回复，即可填充ARP表。

#### 发送数据到子网之外

我们此前提到过，我们只要求交换局域网内的MAC地址唯一，而此前的ARP解析直接工作在链路层上，不含有网络层信息，因此不能被路由器转发。
这两种困难导致ARP只能在一个子网（即路由局域网）中工作，而不能跨越路由器将数据传输到子网之外。

子网是一个网络层概念，因此转发到子网之外显然需要借助网络层手段，实际上，这正是通过路由表实现的。
此前介绍路由表时提到过，路由表中含有**网关**（Gateway）字段，这一字段可以用来跨越子网。
网关是指连接多个网络的硬件设备，在我们的讨论中，通常指的就是路由器。
如果匹配的IP地址在同一子网中，这一字段通常用`0.0.0.0`（IPv4）或`::`（IPv6）表示。

网络层在将数据报交付给链路层的时候，首先检查目的IP地址对应路由表中的网关，如果在同一子网内，那么通知链路层直接选择使用ARP解析得到的*接收方MAC地址*。
相对地，如果不在同一子网内，那么通知链路层使用ARP解析得到*网关的MAC地址*，将帧交给网关。
网关（即路由器）收到此帧后，根据网络层数据进行路由，得出目的地的MAC地址（无论是使用接收方还是继续使用网关地址），再封装成帧，如此往复，直至发送到接收方。

值得注意的是路由器的两个端口之间可能不使用相同的链路层协议，比如家用路由器就同时支持以太网和802.11 WiFi。
幸运的是，只要仍使用TCP/IP协议栈，那么MAC地址的形式就是相同的，只是路由器必须使用不同的结构来封装链路层帧。
